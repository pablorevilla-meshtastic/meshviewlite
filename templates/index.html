{% extends "base.html" %}

{% block body %}
{% include "search_form.html" %}
<div class="panel">
  <table>
    <thead>
      <tr><th>Long Name</th><th>Short Name</th><th>Hex ID</th><th>Model</th><th>Role</th><th>Channel</th><th>Last Seen</th></tr>
    </thead>
    <tbody id="node_list">
      <tr><td colspan="7" class="muted">Loading nodes...</td></tr>
    </tbody>
  </table>
  <div style="display:flex;gap:10px;align-items:center;justify-content:flex-end;margin-top:10px;">
    <a id="prev_page" class="btn" href="#" style="text-decoration:none;">Prev</a>
    <span id="page_info" class="muted">Page 1</span>
    <a id="next_page" class="btn" href="#" style="text-decoration:none;">Next</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function escapeHtml(text) {
  return String(text ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function formatLocalTime(us) {
  if (!us) return "-";
  const epochMs = Number(us) / 1000;
  if (!Number.isFinite(epochMs)) return "-";
  return new Date(epochMs).toLocaleString();
}

async function loadNodes() {
  const tbody = document.getElementById("node_list");
  const countBadge = document.getElementById("node_count_badge");
  const prevPage = document.getElementById("prev_page");
  const nextPage = document.getElementById("next_page");
  const pageInfo = document.getElementById("page_info");
  const query = new URLSearchParams(window.location.search).get("q");
  const q = (query || "").trim().toLowerCase();
  const pageRaw = new URLSearchParams(window.location.search).get("page");
  const page = Math.max(parseInt(pageRaw || "1", 10) || 1, 1);

  try {
    const apiUrl = new URL("/api/nodes", window.location.origin);
    apiUrl.searchParams.set("limit", "50");
    apiUrl.searchParams.set("page", String(page));
    if (q) apiUrl.searchParams.set("q", q);

    const res = await fetch(apiUrl.toString());
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">Failed to load nodes (${res.status})</td></tr>`;
      return;
    }
    const data = await res.json();
    const nodes = data.nodes || [];
    const total = Number(data.total || nodes.length);
    const hasPrev = Boolean(data.has_prev);
    const hasNext = Boolean(data.has_next);
    if (countBadge) countBadge.textContent = `Nodes: ${total}`;
    if (pageInfo) pageInfo.textContent = `Page ${page}`;
    const qsFor = (p) => {
      const sp = new URLSearchParams(window.location.search);
      if (q) sp.set("q", q); else sp.delete("q");
      sp.set("page", String(p));
      return `/?${sp.toString()}`;
    };
    if (prevPage) {
      prevPage.href = hasPrev ? qsFor(page - 1) : "#";
      prevPage.style.pointerEvents = hasPrev ? "auto" : "none";
      prevPage.style.opacity = hasPrev ? "1" : "0.5";
    }
    if (nextPage) {
      nextPage.href = hasNext ? qsFor(page + 1) : "#";
      nextPage.style.pointerEvents = hasNext ? "auto" : "none";
      nextPage.style.opacity = hasNext ? "1" : "0.5";
    }

    if (!nodes.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">No nodes found.</td></tr>`;
      return;
    }

    tbody.innerHTML = nodes.map((n) => {
      const nodeId = n.node_id ?? "";
      const longLabel = n.long_name || n.id || String(nodeId);
      return `
        <tr>
          <td><a href="/node/${encodeURIComponent(nodeId)}">${escapeHtml(longLabel)}</a></td>
          <td>${escapeHtml(n.short_name || "-")}</td>
          <td>${escapeHtml(n.id || "-")}</td>
          <td>${escapeHtml(n.hw_model || "-")}</td>
          <td>${escapeHtml(n.role || "-")}</td>
          <td>${escapeHtml(n.channel || "-")}</td>
          <td>${escapeHtml(formatLocalTime(n.last_seen_us))}</td>
        </tr>
      `;
    }).join("");

  } catch (err) {
    console.error("Failed to load nodes", err);
    if (countBadge) countBadge.textContent = "Nodes: ?";
    tbody.innerHTML = `<tr><td colspan="7" class="muted">Failed to load nodes</td></tr>`;
  }
}

document.addEventListener("DOMContentLoaded", loadNodes);
</script>
{% endblock %}
