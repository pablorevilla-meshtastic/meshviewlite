{% extends "base.html" %}

{% block body %}
{% include "search_form.html" %}
<div class="panel">
  <table>
    <thead>
      <tr><th>Long Name</th><th>Short Name</th><th>Hex ID</th><th>Model</th><th>Role</th><th>Channel</th><th>Last Seen</th></tr>
    </thead>
    <tbody id="node_list">
      <tr><td colspan="7" class="muted">Loading nodes...</td></tr>
    </tbody>
  </table>
</div>
{% endblock %}

{% block scripts %}
<script>
function escapeHtml(text) {
  return String(text ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function formatLocalTime(us) {
  if (!us) return "-";
  const epochMs = Number(us) / 1000;
  if (!Number.isFinite(epochMs)) return "-";
  return new Date(epochMs).toLocaleString();
}

function nodeMatchesQuery(node, q) {
  if (!q) return true;
  const hay = [
    node.node_id,
    node.id,
    node.long_name,
    node.short_name,
    node.hw_model,
    node.role,
    node.channel
  ]
    .map((v) => String(v ?? "").toLowerCase())
    .join(" ");
  return hay.includes(q);
}

async function loadNodes() {
  const tbody = document.getElementById("node_list");
  const countBadge = document.getElementById("node_count_badge");
  const query = new URLSearchParams(window.location.search).get("q");
  const q = (query || "").trim().toLowerCase();

  try {
    const res = await fetch("/api/nodes");
    if (!res.ok) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">Failed to load nodes (${res.status})</td></tr>`;
      return;
    }
    const data = await res.json();
    const nodes = (data.nodes || []).filter((n) => nodeMatchesQuery(n, q));
    if (countBadge) countBadge.textContent = `Nodes: ${nodes.length}`;

    if (!nodes.length) {
      tbody.innerHTML = `<tr><td colspan="7" class="muted">No nodes found.</td></tr>`;
      return;
    }

    nodes.sort((a, b) => (b.last_seen_us || 0) - (a.last_seen_us || 0));

    tbody.innerHTML = nodes.map((n) => {
      const nodeId = n.node_id ?? "";
      const longLabel = n.long_name || n.id || String(nodeId);
      return `
        <tr>
          <td><a href="/node/${encodeURIComponent(nodeId)}">${escapeHtml(longLabel)}</a></td>
          <td>${escapeHtml(n.short_name || "-")}</td>
          <td>${escapeHtml(n.id || "-")}</td>
          <td>${escapeHtml(n.hw_model || "-")}</td>
          <td>${escapeHtml(n.role || "-")}</td>
          <td>${escapeHtml(n.channel || "-")}</td>
          <td>${escapeHtml(formatLocalTime(n.last_seen_us))}</td>
        </tr>
      `;
    }).join("");
  } catch (err) {
    console.error("Failed to load nodes", err);
    if (countBadge) countBadge.textContent = "Nodes: ?";
    tbody.innerHTML = `<tr><td colspan="7" class="muted">Failed to load nodes</td></tr>`;
  }
}

document.addEventListener("DOMContentLoaded", loadNodes);
</script>
{% endblock %}
